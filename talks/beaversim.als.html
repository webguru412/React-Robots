<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="http://alloy.mit.edu/alloy/hola/css/alloy.css"/></head><body>

<div class="highlight"><pre><span class="kn">module</span> <span class="nn">BeaverSim</span>

<span class="k">open</span> <span class="n">util</span><span class="o">/</span><span class="n">ordering</span><span class="o">[</span><span class="n">Time</span><span class="o">]</span> <span class="n">as</span> <span class="n">tOrd</span>

<span class="kd">sig</span> <span class="nc">Time</span> <span class="o">{}</span>

<span class="kd">sig</span> <span class="nc">Beaver</span> <span class="o">{</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="kt">Int</span><span class="o">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Time</span><span class="p">,</span>
  <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">:</span> <span class="kt">Int</span><span class="o">(-</span><span class="mi">1</span><span class="o">..</span><span class="mi">1</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Time</span>
<span class="o">}</span> <span class="o">{</span>
  <span class="k">all</span> <span class="n">t</span><span class="p">:</span> <span class="n">Time</span> <span class="o">{</span>
    <span class="k">one</span> <span class="n">x</span><span class="o">.</span><span class="n">t</span> <span class="ow">and</span> <span class="k">one</span> <span class="n">y</span><span class="o">.</span><span class="n">t</span>
    <span class="k">one</span> <span class="n">vx</span><span class="o">.</span><span class="n">t</span> <span class="ow">and</span> <span class="k">one</span> <span class="n">vy</span><span class="o">.</span><span class="n">t</span>
    <span class="o">(</span><span class="n">vx</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">vy</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">fact</span> <span class="nf">initiallyNotPiledUp</span> <span class="o">{</span>
  <span class="k">no</span> <span class="k">disj</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">:</span> <span class="n">Beaver</span> <span class="o">|</span> <span class="n">samePos</span><span class="o">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">tOrd</span><span class="o">/</span><span class="n">first</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">samePos</span><span class="o">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="kt">Int</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">x1</span> <span class="o">=</span> <span class="n">x2</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">y2</span>
<span class="o">}</span>

<span class="k">pred</span> <span class="nf">samePos</span><span class="o">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">:</span> <span class="n">Beaver</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Time</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">samePos</span><span class="o">[</span><span class="n">b1</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">b1</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">fun</span> <span class="nf">dx</span><span class="o">[</span><span class="n">b</span><span class="p">:</span> <span class="n">Beaver</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t&#39;</span><span class="p">:</span> <span class="n">Time</span><span class="o">]</span><span class="p">:</span> <span class="k">set</span> <span class="kt">Int</span> <span class="o">{</span>
  <span class="o">{</span><span class="n">i</span><span class="p">:</span> <span class="o">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">4</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t&#39;</span><span class="o">)</span> <span class="ow">or</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="o">)}</span>
<span class="o">}</span>

<span class="k">fun</span> <span class="nf">dy</span><span class="o">[</span><span class="n">b</span><span class="p">:</span> <span class="n">Beaver</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t&#39;</span><span class="p">:</span> <span class="n">Time</span><span class="o">]</span><span class="p">:</span> <span class="k">set</span> <span class="kt">Int</span> <span class="o">{</span>
  <span class="o">{</span><span class="n">i</span><span class="p">:</span> <span class="o">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">4</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t&#39;</span><span class="o">)</span> <span class="ow">or</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t</span><span class="o">)}</span>
<span class="o">}</span>

<span class="k">fun</span> <span class="nf">cellsCrossed</span><span class="o">[</span><span class="n">b</span><span class="p">:</span> <span class="n">Beaver</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t&#39;</span><span class="p">:</span> <span class="n">Time</span><span class="o">]</span><span class="p">:</span> <span class="k">set</span> <span class="kt">Int</span> <span class="o">{</span>
  <span class="o">{</span><span class="n">i</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">|</span> <span class="k">some</span> <span class="n">x</span><span class="p">:</span> <span class="n">dx</span><span class="o">[</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t&#39;</span><span class="o">]</span> <span class="o">|</span> <span class="k">some</span> <span class="n">y</span><span class="p">:</span> <span class="n">dy</span><span class="o">[</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t&#39;</span><span class="o">]</span> <span class="o">|</span> <span class="n">i</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mul</span><span class="o">[</span><span class="mi">5</span><span class="o">].</span><span class="n">plus</span><span class="o">[</span><span class="n">x</span><span class="o">]}</span>
<span class="o">}</span>

<span class="k">abstract</span> <span class="kd">sig</span> <span class="nc">Event</span> <span class="o">{</span>
  <span class="n">t</span><span class="p">,</span> <span class="n">t&#39;</span><span class="p">:</span> <span class="n">Time</span>
<span class="o">}</span>

<span class="k">fact</span> <span class="o">{</span>
  <span class="k">all</span> <span class="n">tx</span><span class="p">:</span> <span class="n">Time</span> <span class="o">-</span> <span class="n">tOrd</span><span class="o">/</span><span class="n">last</span> <span class="o">|</span> <span class="k">some</span> <span class="n">e</span><span class="p">:</span> <span class="n">Event</span> <span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">tx</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">next</span>
  <span class="k">all</span> <span class="n">e</span><span class="p">:</span> <span class="n">Event</span> <span class="o">|</span> <span class="n">e</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">t</span><span class="o">).</span><span class="n">next</span>
<span class="o">}</span>

<span class="kd">sig</span> <span class="nc">UpdatePosition</span> <span class="k">extends</span> <span class="n">Event</span> <span class="o">{</span>
<span class="o">}</span>
<span class="c1">// no colision detection</span>
<span class="o">/*{</span>
  <span class="k">all</span> <span class="n">b</span><span class="p">:</span> <span class="n">Beaver</span> <span class="o">{</span>
    <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plus</span><span class="o">[</span><span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">t</span><span class="o">]</span>
    <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plus</span><span class="o">[</span><span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">t</span><span class="o">]</span>
    <span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">t</span>
    <span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">t</span>
  <span class="o">}</span>
<span class="o">}*/</span>
<span class="o">{</span>
  <span class="k">all</span> <span class="n">b</span><span class="p">:</span> <span class="n">Beaver</span> <span class="o">|</span> <span class="k">let</span> <span class="n">x&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plus</span><span class="o">[</span><span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">t</span><span class="o">]</span><span class="p">,</span> <span class="n">y&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plus</span><span class="o">[</span><span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">t</span><span class="o">]</span> <span class="o">{</span>
    <span class="o">(</span><span class="k">no</span> <span class="n">b2</span><span class="p">:</span> <span class="n">Beaver</span> <span class="o">-</span> <span class="n">b</span> <span class="o">|</span>
      <span class="n">samePos</span><span class="o">[</span><span class="n">x&#39;</span><span class="p">,</span> <span class="n">y&#39;</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plus</span><span class="o">[</span><span class="n">b2</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">t</span><span class="o">]</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plus</span><span class="o">[</span><span class="n">b2</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">t</span><span class="o">]]</span>
    <span class="o">)</span> <span class="ow">implies</span> <span class="o">{</span>
	  <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">x&#39;</span>
	  <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">y&#39;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// turn right: R(90) = [ 0, -1; 1, 0 ]</span>
      <span class="k">let</span> <span class="n">vx</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">t</span> <span class="o">{</span>
        <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plus</span><span class="o">[</span><span class="n">vx</span><span class="o">.</span><span class="n">mul</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">plus</span><span class="o">[</span><span class="n">vy</span><span class="o">.</span><span class="n">mul</span><span class="o">[-</span><span class="mi">1</span><span class="o">]]]</span>
        <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">plus</span><span class="o">[</span><span class="n">vx</span><span class="o">.</span><span class="n">mul</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">plus</span><span class="o">[</span><span class="n">vy</span><span class="o">.</span><span class="n">mul</span><span class="o">[</span><span class="mi">0</span><span class="o">]]]</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">t</span>
    <span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">t&#39;</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">t</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">check</span> <span class="n">noCollision</span> <span class="o">{</span>
  <span class="k">no</span> <span class="n">t</span><span class="p">:</span> <span class="n">Time</span> <span class="o">|</span>
    <span class="k">some</span> <span class="k">disj</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">:</span> <span class="n">Beaver</span> <span class="o">|</span>
      <span class="n">samePos</span><span class="o">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">t</span><span class="o">]</span>
      <span class="c1">// t != tOrd/last &amp;&amp; some (cellsCrossed[b1, t, t.next] &amp; cellsCrossed[b2, t, t.next])</span>
<span class="o">}</span> <span class="k">for</span> <span class="mi">2</span> <span class="k">but</span> <span class="o">-</span><span class="mi">2</span><span class="o">..</span><span class="mi">32</span> <span class="kt">Int</span><span class="p">,</span> <span class="mi">2</span> <span class="n">Beaver</span><span class="p">,</span> <span class="k">exactly</span> <span class="mi">2</span> <span class="n">Time</span><span class="p">,</span> <span class="k">exactly</span> <span class="mi">1</span> <span class="n">Event</span>


<span class="o">/*</span><span class="k">pred</span> <span class="nf">zeroSpeedAtStart</span> <span class="o">{</span>
  <span class="k">all</span> <span class="n">b</span><span class="p">:</span> <span class="n">Beaver</span> <span class="o">|</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.(</span><span class="n">tOrd</span><span class="o">/</span><span class="n">first</span><span class="o">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="o">.(</span><span class="n">tOrd</span><span class="o">/</span><span class="n">first</span><span class="o">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">}*/</span>
</pre></div>

</body></html>
